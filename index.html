<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Habit Manager Pro</title>
<style>
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --text:#111;
}
.dark{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#e5e7eb;
}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont;
  background:var(--bg);
  color:var(--text);
}
header{
  position:sticky; top:0;
  background:var(--card);
  padding:10px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  border-bottom:1px solid #ddd;
}
.panel{
  background:var(--card);
  padding:10px;
  border-bottom:1px solid #ddd;
}
.container{ padding:12px; }

table{
  border-collapse:collapse;
  width:100%;
  min-width:700px;
}
th,td{
  border:1px solid #ddd;
  padding:8px;
  text-align:center;
}
.category-label{
  padding:2px 6px;
  border-radius:6px;
  color:#fff;
  font-size:12px;
}
.today{ background:#fde68a; color:#000; }
</style>
</head>

<body>

<header>
  <button onclick="toggleDark()">ğŸŒ™</button>
  <button onclick="goToday()">ì˜¤ëŠ˜</button>
  <input type="date" id="weekPicker">
  <button onclick="exportData()">ë°±ì—…</button>
  <input type="file" id="importFile">
</header>

<div class="panel">
  <b>ê´€ë¦¬ íŒ¨ë„</b><br><br>

  <!-- ì¹´í…Œê³ ë¦¬ -->
  ì¹´í…Œê³ ë¦¬:
  <select id="categorySelect"></select>
  <input id="categoryName" placeholder="ì´ë¦„">
  <input type="color" id="categoryColor">
  <button onclick="addCategory()">ì¶”ê°€</button>
  <button onclick="updateCategory()">ìˆ˜ì •</button>
  <button onclick="deleteCategory()">ì‚­ì œ</button>
  <br><br>

  <!-- ìŠµê´€ -->
  ìŠµê´€:
  <select id="habitSelect"></select>
  <input id="habitName" placeholder="ì´ë¦„">
  <button onclick="addHabit()">ì¶”ê°€</button>
  <button onclick="updateHabit()">ìˆ˜ì •</button>
  <button onclick="deleteHabit()">ì‚­ì œ</button>
  <br><br>

  <!-- ë‹¨ê³„ -->
  ë‹¨ê³„:
  <select id="stageSelect"></select>
  <input id="stageName" placeholder="ì´ë¦„">
  <button onclick="addStage()">ì¶”ê°€</button>
  <button onclick="updateStage()">ìˆ˜ì •</button>
  <button onclick="deleteStage()">ì‚­ì œ</button>
  <br><br>

  <!-- ë°˜ë³µ ì£¼ê¸° -->
  ë°˜ë³µ ì£¼ê¸°:
  <select id="recList"></select>
  <input type="number" id="recDays" placeholder="ì¼ìˆ˜" min="1" style="width:80px">
  <input type="color" id="recColor" value="#f87171">
  <button onclick="addRecurrence()">ì¶”ê°€</button>
  <button onclick="deleteRecurrence()">ì‚­ì œ</button>
</div>

<div class="container">
  <h3>ğŸ“… ì£¼ê°„ ê¸°ë¡</h3>
  <table id="table"></table>

  <h3>ğŸ“Š ë‹¨ê³„ í†µê³„</h3>
  <table id="stats"></table>
</div>

<script>
let categories=JSON.parse(localStorage.getItem("cat")||"[]");
let habits=JSON.parse(localStorage.getItem("hab")||"[]");
let stages=JSON.parse(localStorage.getItem("stg")||'["ì—†ìŒ"]');
let data=JSON.parse(localStorage.getItem("data")||"{}");
let recurrenceList = JSON.parse(localStorage.getItem("recList")||"[]");
let currentDate=new Date();

function save(){
  localStorage.setItem("cat",JSON.stringify(categories));
  localStorage.setItem("hab",JSON.stringify(habits));
  localStorage.setItem("stg",JSON.stringify(stages));
  localStorage.setItem("data",JSON.stringify(data));
  localStorage.setItem("recList",JSON.stringify(recurrenceList));
}

/* ë‚ ì§œ */
function getWeek(d){
  let date=new Date(d);
  let day=date.getDay();
  let diff=date.getDate()-day+(day===0?-6:1);
  let monday=new Date(date.setDate(diff));
  let arr=[];
  for(let i=0;i<7;i++){
    let nd=new Date(monday);
    nd.setDate(monday.getDate()+i);
    arr.push(nd);
  }
  return arr;
}

/* ë Œë” */
function render(){
  renderSelects();
  renderTable();
  renderStats();
  save();
}

/* SELECT */
function renderSelects(){
  categorySelect.innerHTML="";
  categories.forEach((c,i)=>{
    categorySelect.innerHTML+=`<option value="${i}">${c.name}</option>`;
  });

  habitSelect.innerHTML="";
  habits.forEach((h,i)=>{
    habitSelect.innerHTML+=`<option value="${i}">${h.name}</option>`;
  });

  stageSelect.innerHTML="";
  stages.forEach((s,i)=>{
    stageSelect.innerHTML+=`<option value="${i}">${s}</option>`;
  });

  recList.innerHTML="";
  recurrenceList.forEach((r,i)=>{
    recList.innerHTML+=`<option value="${i}">${r.days}ì¼</option>`;
  });
}

/* CATEGORY */
function addCategory(){ categories.push({name:categoryName.value,color:categoryColor.value}); render(); }
function updateCategory(){ let i=categorySelect.value; categories[i]={name:categoryName.value,color:categoryColor.value}; render(); }
function deleteCategory(){ categories.splice(categorySelect.value,1); habits=habits.filter(h=>h.cat!=categorySelect.value); render(); }

/* HABIT */
function addHabit(){ habits.push({name:habitName.value,cat:categorySelect.value}); render(); }
function updateHabit(){ let i=habitSelect.value; habits[i].name=habitName.value; habits[i].cat=categorySelect.value; render(); }
function deleteHabit(){ let hName = habits[habitSelect.value].name; habits.splice(habitSelect.value,1); render(); }

/* STAGE */
function addStage(){ stages.push(stageName.value); render(); }
function updateStage(){ stages[stageSelect.value]=stageName.value; render(); }
function deleteStage(){ if(stages.length>1){ stages.splice(stageSelect.value,1); render(); } }

/* RECURRENCE */
function addRecurrence(){
  const days = parseInt(recDays.value);
  const color = recColor.value;
  if(!days || days<1) return alert("ë°˜ë³µì¼ìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”");
  recurrenceList.push({days,color});
  render();
}
function deleteRecurrence(){ recurrenceList.splice(recList.value,1); render(); }

/* TABLE */
function renderTable(){
  const week=getWeek(currentDate);
  const today=new Date().toDateString();
  table.innerHTML="";

  let sortedHabits=[...habits].sort((a,b)=>a.cat-b.cat);

  let header="<tr><th>ìŠµê´€</th>";
  week.forEach(d=>{
    header+=`<th class="${d.toDateString()==today?"today":""}">${d.getMonth()+1}/${d.getDate()}</th>`;
  });
  header+="</tr>";
  table.innerHTML+=header;

  sortedHabits.forEach(h=>{
    const cat=categories[h.cat]||{name:"",color:"#999"};
    let row=`<tr><td><span class="category-label" style="background:${cat.color}">${cat.name}</span> ${h.name}</td>`;

    week.forEach(d=>{
      let key=h.name+d.toDateString();
      let v = data[key] || 0;
      let recStyle = "";

      if(recurrenceList.length>0){
        let lastKey = Object.keys(data)
          .filter(k=>k.startsWith(h.name) && data[k]==stages.length-1)
          .sort((a,b)=>new Date(a.slice(h.name.length)) - new Date(b.slice(h.name.length)))
          .pop();
        if(lastKey){
          let lastDate = new Date(lastKey.slice(h.name.length));
          recurrenceList.forEach(r=>{
            let diffDays = Math.floor((d - lastDate)/(1000*60*60*24));
            if(diffDays===r.days){
              recStyle = `background:${r.color}; color:#fff;`;
            }
          });
        }
      }

      row+=`<td onclick="cycle('${key}')" style="${recStyle}">${stages[v]}</td>`;
    });

    row+="</tr>";
    table.innerHTML+=row;
  });
}

/* STAT */
function renderStats(){
  stats.innerHTML="";
  let header="<tr><th>ìŠµê´€</th>";
  stages.forEach(s=>header+=`<th>${s}</th>`);
  header+="</tr>";
  stats.innerHTML+=header;

  let sortedHabits=[...habits].sort((a,b)=>a.cat);

  sortedHabits.forEach(h=>{
    const cat=categories[h.cat]||{color:"#999",name:""};
    let row=`<tr><td><span class="category-label" style="background:${cat.color}">${cat.name}</span> ${h.name}</td>`;
    stages.forEach((s,i)=>{
      let count=0;
      Object.keys(data).forEach(k=>{
        if(k.startsWith(h.name) && data[k]==i) count++;
      });
      row+=`<td>${count}</td>`;
    });
    row+="</tr>";
    stats.innerHTML+=row;
  });
}

/* CYCLE */
function cycle(key){
  let v=data[key]||0;
  v=(v+1)%stages.length;
  data[key]=v;
  render();
}

/* DARK */
function toggleDark(){ document.body.classList.toggle("dark"); }

/* TODAY */
function goToday(){ currentDate=new Date(); weekPicker.valueAsDate=currentDate; render(); }
weekPicker.addEventListener("change",e=>{ currentDate=new Date(e.target.value); render(); });

/* BACKUP */
function exportData(){
  const blob=new Blob([JSON.stringify({categories,habits,stages,data,recurrenceList})],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="habit_backup.json";
  a.click();
}
document.getElementById("importFile").addEventListener("change",e=>{
  const file=e.target.files[0];
  const reader=new FileReader();
  reader.onload=()=>{
    const obj=JSON.parse(reader.result);
    categories=obj.categories||[];
    habits=obj.habits||[];
    stages=obj.stages||["ì—†ìŒ"];
    data=obj.data||{};
    recurrenceList=obj.recurrenceList||[];
    render();
  };
  reader.readAsText(file);
});

goToday();
</script>

</body>
</html>
